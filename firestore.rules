rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ══ DEFAULT: deny all ══
    match /{document=**} {
      allow read, write: if false;
    }

    // ══ NEGOCIOS: public read, owner/admin write ══
    match /negocios/{negocioId} {
      allow read;
      allow write: if request.auth != null
        && (request.auth.uid == resource.data.ownerId
        || request.auth.token.admin == true);
      // Allow create for new negocios (onboarding)
      allow create: if request.auth != null;

      // Productos subcollection
      match /productos/{productoId} {
        allow read;
        allow write: if request.auth != null
          && request.auth.uid == get(/databases/$(database)/documents/negocios/$(negocioId)).data.ownerId
          || request.auth.token.admin == true;
      }
    }

    // ══ NEGOCIO USUARIOS: login queries ══
    match /negocio_usuarios/{userId} {
      allow read;
      allow create;
      allow update: if request.auth != null;
    }

    // ══ PEDIDOS: create public, read/update restricted ══
    match /pedidos/{pedidoId} {
      allow create;
      allow read;
      allow update: if request.auth != null;
      allow delete: if false;

      // Chat subcollection
      match /chat/{msgId} {
        allow read;
        allow create;
      }
    }

    // ══ COUNTERS: for order numbering ══
    match /counters/{counterId} {
      allow read, write;
    }

    // ══ FARMACIA PRODUCTOS: public catalog ══
    match /farmacia_productos/{productoId} {
      allow read;
      allow write: if request.auth != null;
    }

    // ══ CALIFICACIONES: public read, authenticated create, no edit/delete ══
    match /calificaciones/{calId} {
      allow read;
      allow create;
      allow update, delete: if false;
    }

    // ══ CUPONES: public read, admin write ══
    match /cupones/{cuponId} {
      allow read;
      allow write: if request.auth != null
        && request.auth.token.admin == true;
    }

    // ══ NEGOCIOS PROPUESTOS: public create, admin manage ══
    match /negocios_propuestos/{propId} {
      allow read;
      allow create;
      allow update, delete: if request.auth != null
        && request.auth.token.admin == true;
    }

    // ══ FRANQUICIA SOLICITUDES: public create, admin manage ══
    match /franquicia_solicitudes/{solId} {
      allow read: if request.auth != null
        && request.auth.token.admin == true;
      allow create;
      allow update, delete: if request.auth != null
        && request.auth.token.admin == true;
    }

    // ══ TICKETS: owner + admin read, admin write ══
    match /tickets/{ticketId} {
      allow read;
      allow write: if request.auth != null;
      allow delete: if false;
    }

    // ══ REPARTIDORES: self + admin ══
    match /repartidores/{repartidorId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // ══ ADMIN / SUDO: only admin ══
    match /admin/{document=**} {
      allow read, write: if request.auth != null
        && request.auth.token.admin == true;
    }

    // ══ CRUDO PEDIDOS ══
    match /crudo_pedidos/{pedidoId} {
      allow create;
      allow read: if request.auth != null;
    }

    // ══ SHARAZAN PEDIDOS ══
    match /sharazan_pedidos/{pedidoId} {
      allow create;
      allow read: if request.auth != null;
    }
  }
}
